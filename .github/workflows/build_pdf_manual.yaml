name: Build PDF Manual

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-pdf:
    runs-on: ubuntu-latest

    env:
      R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
      RSPM: ${{ matrix.config.rspm }}
      GITHUB_TOKEN: ${{ secrets.AUTOMATISATION }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Setup R
      uses: r-lib/actions/setup-r@v2

    - name: Install linux libraries
      run: |
          sudo apt install libsodium-dev
          sudo apt-get install libcurl4-openssl-dev
          sudo apt-get install libgdal-dev libproj-dev
          sudo apt install libudunits2-dev
          sudo apt install libharfbuzz-dev
          sudo apt install libfribidi-dev

    - name: Install R dependencies
      run: |
        R -e "install.packages('devtools')"
        R -e "install.packages('roxygen2')"

    - name: Install LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-full

    - name: Install R packages
      run: |
        source("preprocessing/install_imports.R")
      shell: Rscript {0}

    - name: cleanup_reference_manual
      run: |
        source("preprocessing/cleanup_reference_manual.R")
      shell: Rscript {0}

    - name: Build and document package
      run: |
        R -e "devtools::document()"

    - name: Generate PDF manual
      run: |
        R CMD Rd2pdf . -o fistools.pdf

    - name: Commit and push changes
      uses: devops-infra/action-commit-push@master
      with:
          github_token: ${{ secrets.AUTOMATISATION }}
          commit_prefix: "[AUTO]"
          commit_message: "update fistools.pdf"
